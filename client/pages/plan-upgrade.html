<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
  <title>Upgrading Your Plan</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/plan-upgrade.css">
</head>
<body>
  <header class="upgrade-header" role="banner">
    <div class="header">
      <div class="logo">
        <a href="../index.html">
          <img src="../assets/rtb-logo-white.png" alt="Raising The Bar Logo">
        </a>
      </div>
    </div>
  </header>
  <main class="upgrade-main" role="main">
    <section class="upgrade-card" aria-labelledby="upgrade-title">
      <p class="kicker">Thank you for leveling up</p>
      <h1 id="upgrade-title">We&#8217;re upgrading your plan</h1>
      <!-- <p class="message">Hang tight while we finish unlocking your new features.</p> -->
      <div class="progress-section">
        <p class="progress-label">Redirecting to your dashboard in <span id="upgrade-countdown">5</span> seconds&#8230;</p>
        <div class="progress-bar" role="progressbar" aria-label="Upgrade progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <span class="progress-fill" id="upgrade-progress" aria-hidden="true"></span>
        </div>
        <p class="progress-hint">You&#8217;ll be taken to your dashboard automatically once everything is ready.</p>
      </div>
      <!-- <a class="dashboard-link" id="upgrade-dashboard-link" href="/pages/dashboard.html">Skip the wait &mdash; take me there now</a> -->
    </section>
  </main>
  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const nextUrl = params.get('next') || '/pages/dashboard.html';
      const countdownEl = document.getElementById('upgrade-countdown');
      const progressFill = document.getElementById('upgrade-progress');
      const progressBar = document.querySelector('.progress-bar');
      const dashboardLink = document.getElementById('upgrade-dashboard-link');
      const totalDuration = 5000;
      let lastDisplayed = 5;
      let hasRedirected = false;

      countdownEl.textContent = String(lastDisplayed);
      // dashboardLink.setAttribute('href', nextUrl);
      // dashboardLink.addEventListener('click', (event) => {
      //   event.preventDefault();
      //   hasRedirected = true;
      //   window.location.href = nextUrl;
      // });

      const updateFrame = (startTime) => (now) => {
        if (hasRedirected) {
          return;
        }
        const elapsed = now - startTime;
        const clamped = Math.min(elapsed, totalDuration);
        const progress = clamped / totalDuration;
        const percent = Math.round(progress * 100);
        progressFill.style.transform = `scaleX(${progress})`;
        progressBar.setAttribute('aria-valuenow', String(percent));

        const remainingSeconds = Math.max(0, Math.ceil((totalDuration - clamped) / 1000));
        if (remainingSeconds !== lastDisplayed) {
          lastDisplayed = remainingSeconds;
          countdownEl.textContent = String(remainingSeconds);
        }

        if (elapsed < totalDuration) {
          window.requestAnimationFrame(updateFrame(startTime));
        } else if (!hasRedirected) {
          hasRedirected = true;
          window.location.href = nextUrl;
        }
      };

      const startAnimation = (startTime) => {
        window.requestAnimationFrame(updateFrame(startTime));
      };

      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        progressFill.style.transition = 'none';
        progressFill.style.transform = 'scaleX(1)';
        progressBar.setAttribute('aria-valuenow', '100');
        countdownEl.textContent = '0';
        window.setTimeout(() => {
          if (!hasRedirected) {
            hasRedirected = true;
            window.location.href = nextUrl;
          }
        }, 500);
        return;
      }

      window.requestAnimationFrame((startTime) => {
        startAnimation(startTime);
        window.setTimeout(() => {
          if (!hasRedirected) {
            hasRedirected = true;
            window.location.href = nextUrl;
          }
        }, totalDuration + 200);
      });
    })();
  </script>
</body>
</html>